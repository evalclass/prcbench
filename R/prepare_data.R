#' Generate an input dataset class for performance evaluation tools
#'
#' The \code{prcdata_generator} function creates an \code{R6} class that
#'  can be used as an input dataset for performance evaluation tools.
#'
#' @return PRCData \code{R6} class.
#'
#' @seealso \code{\link{PRCData}} is generated by this function.
#'
#' @examples
#' ## Generate input data object
#' prcdata_cls <- prcdata_generator()
#'
#' ## An object needs to be instantiated from the class
#' ## before calling any methods
#' prcdata <- idata_cls$new(c(0.1, 0.2, 0.3), c(0, 1, 1), "m1")
#'
#' @export
prcdata_generator <- function() {

  # R6 class
  dataclass <- R6::R6Class("PRCData",
    public = list(
      initialize = function(scores = NULL, labels = NULL, datname = NA) {

        # Validate arguments
        .validate_prcdata(scores, labels)

        # Get unique lables
        ulabs <- .get_uniq_labels(labels)

        # Set private fields
        private$datname <- datname
        private$scores <- scores
        private$labels <- labels
        private$fg <- scores[labels == ulabs[2]]
        private$bg <- scores[labels == ulabs[1]]
        private$fname <- .write_auccalc_input_file(scores, labels)

        # Finalizer
        reg.finalizer(self, function(e) {self$del_file()}, onexit = TRUE)
      },
      get_datname = function() {private$datname},
      get_scores = function() {private$scores},
      get_labels = function() {private$labels},
      get_fg = function() {private$fg},
      get_bg = function() {private$bg},
      get_fname = function() {private$fname},
      del_file = function() {
        if (!is.na(private$fname) && file.exists(private$fname)) {
          file.remove(private$fname)
        }
        private$fname <- NA
      }
    ),
    private = list(
      datname = NA,
      scores = NA,
      labels = NA,
      fg = NA,
      bg = NA,
      fname = NA
    )
  )

  dataclass
}

#
# Validate scores and labels
#
.validate_prcdata <- function(scores, labels) {
  # Check scores
  .validate_scores(scores)

  # Check labels
  .validate_labels(labels)

  # Check length of scores and labels
  if (length(labels) != length(scores)) {
    stop("scores and labels must be the same lengths", call. = FALSE)
  }
}

#
# Validate scores
#
.validate_scores <- function(scores) {
  assertthat::assert_that(is.atomic(scores),
                          is.vector(scores),
                          is.numeric(scores),
                          length(scores) > 0L)
}

#
# Validate labels
#
.validate_labels <- function(labels) {
  assertthat::assert_that(is.atomic(labels),
                          (is.vector(labels) || is.factor(labels)),
                          length(labels) > 0L,
                          length(unique(labels)) == 2L)
}

#
# Get positive and negative labels
#
.get_uniq_labels <- function(labels) {
  ulables <- unique(labels)
  pos_label <- max(ulables)
  neg_label <- min(ulables)

  c(neg_label, pos_label)
}

#
# Create an input file
#
.write_auccalc_input_file <- function(scores, labels) {
  # Create a combined line
  dlines <- paste(scores, labels, sep = "\t", collapse = "\n")

  # Get a temp file name
  fname <- tempfile("prcdata_", fileext = c(".txt"))

  # Write data (use writeLines to avoid '\n' in the last line)
  file_con <- file(fname)
  writeLines(dlines, file_con, sep = "")
  close(file_con)

  # Return the file name
  fname
}
